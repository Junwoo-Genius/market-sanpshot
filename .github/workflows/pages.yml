name: Publish report.json to Pages

on:
  workflow_run:
    workflows: ["Snapshot (stooq)"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

# 구글 드라이브 업로드 단계 (에러 수정 버전)
      - name: Upload Report to Google Drive
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          pip install google-api-python-client google-auth
          python -c "
          import os, json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # 1. 서비스 계정 인증
          info = json.loads(os.environ['GCP_SA_KEY'])
          creds = service_account.Credentials.from_service_account_info(info)
          service = build('drive', 'v3', credentials=creds)

          # 2. 설정 (폴더 ID 및 파일 경로)
          folder_id = '1X9Yec4i9ncvAltPpwQn1J-FNkxrdbiGW'
          file_path = 'public/report.json'
          
          file_metadata = {
              'name': 'report.json',
              'parents': [folder_id]
          }
          media = MediaFileUpload(file_path, mimetype='application/json', resumable=True)

          # 3. 기존 파일이 있는지 검색 (공유 드라이브 옵션 포함)
          query = f\"name='report.json' and '{folder_id}' in parents and trashed=false\"
          results = service.files().list(
              q=query, 
              fields='files(id)', 
              supportsAllDrives=True, 
              includeItemsFromAllDrives=True
          ).execute()
          files = results.get('files', [])

          # 4. 업로드 실행
          try:
              if files:
                  file_id = files[0]['id']
                  # 기존 파일 업데이트
                  service.files().update(
                      fileId=file_id, 
                      media_body=media, 
                      supportsAllDrives=True
                  ).execute()
                  print(f'성공: 기존 파일을 업데이트했습니다. (ID: {file_id})')
              else:
                  # 새 파일 생성
                  file = service.files().create(
                      body=file_metadata, 
                      media_body=media, 
                      fields='id', 
                      supportsAllDrives=True
                  ).execute()
                  print(f'성공: 새 파일을 생성했습니다. (ID: {file.get(\"id\")})')
          except Exception as e:
              print(f'에러 발생: {e}')
              exit(1)
          "
